{% extends 'ski_manufacturing_app/base.html' %}

{% block title %}Employee Management{% endblock %}

{% block extra_head %}
<style>
    .employee-item {
        border: 1px solid #ddd;
        margin: 10px 0;
        padding: 15px;
        border-radius: 4px;
    }
    .employee-actions {
        margin-top: 10px;
    }
    .btn-add {
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
    <h1>Employee Management</h1>

    {% if user.is_staff %}
        <button class="btn btn-primary btn-add" onclick="showAddEmployeeForm()">Add New Employee</button>
    {% endif %}

    <!-- Add/Edit Employee Form -->
    <div id="employee-form" style="display: none;" class="mb-4">
        <h3 id="form-title">Add New Employee</h3>
        <form id="employee-form-element">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="form-group" id="password-group">
                <label for="password">Password:</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="form-group">
                <label for="position">Position:</label>
                <input type="text" class="form-control" id="position" required>
            </div>
            <div class="form-group">
                <label for="training_status">Training Status:</label>
                <select class="form-control" id="training_status">
                    <option value="true">Trained</option>
                    <option value="false">In Training</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" onclick="hideEmployeeForm()">Cancel</button>
        </form>
    </div>

    <div id="employee-list">
        <!-- Employees will be loaded here -->
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentEmployeeId = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    $(document).ready(function() {
        loadEmployees();
        setupFormHandler();
    });

    function loadEmployees() {
        $.ajax({
            url: '/api/employees/',
            type: 'GET',
            success: function(employees) {
                $('#employee-list').empty();
                employees.forEach(function(employee) {
                    const employeeHtml = `
                        <div class="employee-item" data-id="${employee.user.id}">
                            <h3>${employee.user.username}</h3>
                            <p><strong>Position:</strong> ${employee.position}</p>
                            <p><strong>Training Status:</strong> ${employee.training_status ? 'Trained' : 'In Training'}</p>
                            <p><strong>Name:</strong> ${employee.user.first_name} ${employee.user.last_name}</p>
                            <p><strong>Email:</strong> ${employee.user.email || 'N/A'}</p>
                            <div class="employee-actions">
                                <button class="btn btn-warning" onclick="editEmployee(${employee.user.id})">Edit</button>
                                <button class="btn btn-danger" onclick="deleteEmployee(${employee.user.id})">Delete</button>
                            </div>
                        </div>
                    `;
                    $('#employee-list').append(employeeHtml);
                });
            },
            error: function(xhr) {
                $('#employee-list').html('<p class="text-danger">Error loading employees</p>');
            }
        });
    }

    function showAddEmployeeForm() {
        currentEmployeeId = null;
        $('#form-title').text('Add New Employee');
        $('#password-group').show();
        $('#employee-form-element')[0].reset();
        $('#employee-form').show();
    }

    function hideEmployeeForm() {
        $('#employee-form').hide();
        $('#employee-form-element')[0].reset();
    }

    function setupFormHandler() {
        $('#employee-form-element').on('submit', function(e) {
            e.preventDefault();
            const employeeData = {
                username: $('#username').val(),
                position: $('#position').val(),
                training_status: $('#training_status').val() === 'true'
            };

            if (!currentEmployeeId) {
                employeeData.password = $('#password').val();
            }

            const url = currentEmployeeId 
                ? `/api/employees/${currentEmployeeId}/`
                : '/api/employees/';
            const method = currentEmployeeId ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(employeeData),
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function() {
                    hideEmployeeForm();
                    loadEmployees();
                },
                error: function(xhr) {
                    alert('Error saving employee: ' + xhr.responseText);
                }
            });
        });
    }

    function editEmployee(employeeId) {
        currentEmployeeId = employeeId;
        $('#form-title').text('Edit Employee');
        $('#password-group').hide();

        $.ajax({
            url: `/api/employees/${employeeId}/`,
            type: 'GET',
            success: function(employee) {
                $('#username').val(employee.user.username);
                $('#position').val(employee.position);
                $('#training_status').val(employee.training_status.toString());
                $('#employee-form').show();
            },
            error: function(xhr) {
                alert('Error loading employee details');
            }
        });
    }

    function deleteEmployee(employeeId) {
        if (!confirm('Are you sure you want to delete this employee?')) {
            return;
        }

        $.ajax({
            url: `/api/employees/${employeeId}/`,
            type: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function() {
                loadEmployees();
            },
            error: function(xhr) {
                alert('Error deleting employee');
            }
        });
    }
</script>
{% endblock %}