<!DOCTYPE html>
<html>
<head>
    <title>Order List</title>
    <!-- Include jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .btn { margin: 2px; }
        .order-item { border: 1px solid #ddd; margin: 10px 0; padding: 10px; }
        #auth-status { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>
    <div id="auth-status">
        {% if user.is_authenticated %}
            Welcome, {{ user.username }}!
            <a href="{% url 'logout' %}">Logout</a>
        {% else %}
            <a href="{% url 'login' %}">Login</a>
        {% endif %}
    </div>

    <h1>Order List</h1>

    {% if user.is_authenticated and user.is_staff %}
        <a href="#" id="add-order" class="btn btn-primary">Add Order</a>
    {% endif %}

    <div id="order-list"></div>

    <script>
    // Pass staff status from Django to JS
    var isStaff = {{ user.is_staff|yesno:"true,false" }};
    var isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

    // Utility to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    // Load orders on page load
    $(document).ready(function() {
        loadOrders();
    });

    function loadOrders() {
        $.ajax({
            url: '/api/orders/',
            type: 'GET',
            dataType: 'json',
            success: function(orders) {
                $('#order-list').empty();
                if (orders.length === 0) {
                    $('#order-list').append('<p>No orders found.</p>');
                }
                orders.forEach(function(order) {
                    let orderHtml = `
                        <div class="order-item" data-id="${order.id}">
                            <h2>Order ID: ${order.id}</h2>
                            <p>Customer: ${order.customer_name}</p>
                            <p>Product: ${order.product_name}</p>
                            <p>Quantity: ${order.quantity}</p>
                            <p>Status: ${order.status}</p>
                            <p>Order Placed On: ${order.date}</p>
                            ${isStaff ? `
                                <button class="btn btn-warning edit-order">Edit</button>
                                <button class="btn btn-danger delete-order">Delete</button>
                            ` : ''}
                        </div>
                    `;
                    $('#order-list').append(orderHtml);
                });
            },
            error: function(error) {
                $('#order-list').html('<p>Error loading orders.</p>');
            }
        });
    }

    // Delete order (employee only)
    $('#order-list').on('click', '.delete-order', function() {
        if (!confirm('Are you sure you want to delete this order?')) return;
        let orderId = $(this).closest('.order-item').data('id');
        $.ajax({
            url: `/api/orders/${orderId}/`,
            type: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function() {
                loadOrders(); // Refresh the list
            },
            error: function(error) {
                alert('Error deleting order.');
            }
        });
    });

    // Add order (employee only)
    $('#add-order').on('click', function() {
        if (!isAuthenticated) {
            alert('You must be logged in to add an order.');
            return;
        }
        // Redirect to add order page or show a modal
        window.location.href = '/orders/add/';
    });

    // Edit order (employee only)
    $('#order-list').on('click', '.edit-order', function() {
        if (!isAuthenticated) {
            alert('You must be logged in to edit an order.');
            return;
        }
        let orderId = $(this).closest('.order-item').data('id');
        // Redirect to edit order page
        window.location.href = `/orders/edit/${orderId}/`;
    });

    </script>
</body>
</html>
