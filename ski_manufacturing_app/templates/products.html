{% extends 'ski_manufacturing_app/base.html' %}

{% block title %}Product List{% endblock %}

{% block content %}
    <h1>Product List</h1>

    {% if user.is_authenticated and user.is_staff %}
        <a href="{% url 'add-product' %}" id="add-product" class="btn btn-primary">Add Product</a>
    {% endif %}

    <div id="product-list"></div>
{% endblock %}14-


    <script>
    const isStaff = "{{ user.is_staff|yesno:'true,false' }}";
    const isAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}";

    // Utility to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Load products on page load
    $(document).ready(function() {
        loadProducts();
    });

    function loadProducts() {
        $.ajax({
            url: '/api/products/',
            type: 'GET',
            dataType: 'json',
            success: function(products) {
                $('#product-list').empty();
                if (products.length === 0) {
                    $('#product-list').append('<p>No products found.</p>');
                }
                products.forEach(function(product) {
                    let productHtml = `
                        <div class="product-item" data-id="${product.id}">
                            <h2>${product.name}</h2>
                            <p>${product.description || ''}</p>
                            <p>Size: ${product.size}</p>
                            <p>Price: $${product.price}</p>
                            ${product.imagepath ? `<img src="${product.imagepath}" alt="${product.name}" width="200">` : ''}
                            <button class="btn btn-success buy-now" onclick="window.location.href='/products/' + ${product.id} + '/buy/'">Buy Now</button>
                            ${isStaff ? `
                                <button class="btn btn-warning edit-product" onclick="window.location.href='/products/' + ${product.id} + '/edit/'">Edit</button>
                                <button class="btn btn-danger delete-product">Delete</button>
                            ` : ''}
                        </div>
                    `;
                    $('#product-list').append(productHtml);
                });
            },
            error: function(error) {
                $('#product-list').html('<p>Error loading products.</p>');
            }
        });
    }

    // Delete product (employee only)
    $('#product-list').on('click', '.delete-product', function() {
        if (!confirm('Are you sure you want to delete this product?')) return;
        let productId = $(this).closest('.product-item').data('id');
        $.ajax({
            url: `/api/products/${productId}/`,
            type: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function() {
                loadProducts(); // Refresh the list
            },
            error: function(error) {
                alert('Error deleting product.');
            }
        });
    });
    </script>